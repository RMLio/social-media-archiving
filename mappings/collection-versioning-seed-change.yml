prefixes:
  idlab-fn: "http://example.com/idlab/function/"
  dc: "http://purl.org/dc/elements/1.1/"
  dcterms: "http://purl.org/dc/terms/"
  dcmitype: "http://purl.org/dc/dcmitype/"
  premis: "http://www.loc.gov/premis/rdf/v3/"
  relSubType: "https://id.loc.gov/vocabulary/preservation/relationshipSubType/"
  ebucore: "https://www.ebu.ch/metadata/ontologies/ebucore#"
  grel: "http://users.ugent.be/~bjdmeest/function/grel.ttl#"  
  owl: "http://www.w3.org/2002/07/owl#"
  prov: "http://www.w3.org/ns/prov#"
  xsd: "http://www.w3.org/2001/XMLSchema#"
  edm: "http://www.europeana.eu/schemas/edm/"
  bsm: "http://w3id.org/besocial/ns/model#"
  bsd: "http://w3id.org/besocial/data#"
  bss: "http://w3id.org/besocial/ns/shapes#"
  ex: "http://example.org/ns#"

variables:
  access: &dbHost //${SFM_DB_HOST}:${SFM_DB_PORT}/${SFM_DB_DATABASE}
  type: &dbType postgresql
  queryFormulation: &sqlQueryFormulation sql2008
  referenceFormulation: &csvReferenceFormulation csv
  credentials: &credentials
    username: ${SFM_DB_USER}
    password: ${SFM_DB_PASSWORD}

mappings:

  harvests:
    creator: "<Sven.Lieber@ugent.be>"
    description: ""
    version: "v1.0.0"
    sources:
      - access: *dbHost
        type: *dbType
        credentials: *credentials
        queryFormulation: *sqlQueryFormulation
        referenceFormulation: *csvReferenceFormulation
        query: SELECT c1.collection_id_sfm, h.id as "harvest_id", h.harvest_id as "harvest_id_sfm", h.harvest_type, h.status, h.collection_id, (to_char(h.date_started, 'YYYY-MM-DDT') || to_char(h.date_started, 'HH24:MI:SSOF')) as "harvest_started", (to_char(h.date_ended, 'YYYY-MM-DDT') || to_char(h.date_ended, 'HH24:MI:SSOF')) as "harvest_ended", (to_char(c1.date_updated, 'YYYY-MM-DDT') || to_char(c1.date_updated, 'HH24:MI:SSOF')) as "date_updated", c1.type, c1.history_id FROM ui_harvest h LEFT JOIN ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", sub_c.collection_id as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s JOIN ui_collection sub_c ON s.collection_id=sub_c.id) c1 ON h.collection_id=c1.collection_id AND c1.date_updated = (SELECT MAX(c2.date_updated) FROM ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", NULL as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s) c2 WHERE c2.collection_id=h.collection_id AND c2.date_updated <= h.date_started) ORDER BY h.collection_id, h.date_started;
    s: bsd:harvest_$(harvest_id_sfm)
    po:
      - [a, prov:Activity]
      - [dc:title, "Harvest $(harvest_id_sfm)", en~lang]
      - [dc:description, "A $(harvest_type) harvest with status $(status) for collection $(collection_id_sfm)", en~lang]
      - [prov:used, bsd:harvestSeeds_$(harvest_id_sfm)~iri]
      - [prov:startedAtTime, $(harvest_started), xsd:dateTime]
      - [prov:endedAtTime, $(harvest_ended), xsd:dateTime]


  warcs:
    creator: "<Sven.Lieber@ugent.be>"
    description: ""
    version: "v1.0.0"
    sources:
      - access: *dbHost
        type: *dbType
        credentials: *credentials
        queryFormulation: *sqlQueryFormulation
        referenceFormulation: *csvReferenceFormulation
        query: SELECT w.warc_id, w.path, c1.collection_id_sfm, w.bytes, pg_size_pretty(w.bytes::bigint) as "bytesFormatted", w.sha1, h.id as "harvest_id", h.harvest_id as "harvest_id_sfm", h.harvest_type, h.status, h.collection_id, (to_char(w.date_created, 'YYYY-MM-DDT') || to_char(w.date_created, 'HH24:MI:SSOF')) as "date_created", (to_char(h.date_started, 'YYYY-MM-DDT') || to_char(h.date_started, 'HH24:MI:SSOF')) as "harvest_started", (to_char(h.date_ended, 'YYYY-MM-DDT') || to_char(h.date_ended, 'HH24:MI:SSOF')) as "harvest_ended", (to_char(c1.date_updated, 'YYYY-MM-DDT') || to_char(c1.date_updated, 'HH24:MI:SSOF')) as "date_updated", c1.type, c1.history_id FROM ui_warc w JOIN ui_harvest h ON w.harvest_id=h.id LEFT JOIN ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", sub_c.collection_id as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s JOIN ui_collection sub_c ON s.collection_id=sub_c.id) c1 ON h.collection_id=c1.collection_id AND c1.date_updated = (SELECT MAX(c2.date_updated) FROM ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", NULL as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s) c2 WHERE c2.collection_id=h.collection_id AND c2.date_updated <= h.date_started) ORDER BY h.collection_id, h.date_started;
    s: bsd:warcJSON_$(warc_id)
    po:
      - [a, prov:Entity]
      - [a, premis:File]
      - [dc:title, "WARC $(warc_id)", en~lang]
      - [dc:description, "The WARC file $(warc_id) of size $(bytesFormatted) generated by harvest $(harvest_id_sfm) at $(date_created).", en~lang]
      - [dcterms:identifier, $(warc_id)]
      - [schema:encodingFormat, "application/warc"]
      - [schema:fileSize, $(bytesFormatted)]
      - [premis:size, $(bytes)]
      - [premis:fixity, bsd:warcJSONFixity_$(warc_id)~iri]
      - [premis:originalName, $(path)]
      - [dcterms:format, "application/warc"]
      - [ebucore:hasMimeType, "application/warc"]
      - [dcterms:isPartOf, bsd:collectionVersionJSON_$(collection_id_sfm)_$(type)_$(history_id)~iri]
      - [relSubType:isp, bsd:collectionVersionJSON_$(collection_id_sfm)_$(type)_$(history_id)~iri]
      - [prov:generatedAtTime, $(date_created)]
      - [prov:wasGeneratedBy, bsd:harvest_$(harvest_id_sfm)~iri]


  warcsFixity:
    creator: "<Sven.Lieber@ugent.be>"
    description: ""
    version: "v1.0.0"
    sources:
      - access: *dbHost
        type: *dbType
        credentials: *credentials
        queryFormulation: *sqlQueryFormulation
        referenceFormulation: *csvReferenceFormulation
        query: SELECT w.warc_id, c1.collection_id_sfm, w.bytes, pg_size_pretty(w.bytes::bigint) as bytesFormatted, w.sha1, h.id as "harvest_id", h.harvest_id as "harvest_id_sfm", h.harvest_type, h.status, h.collection_id, (to_char(w.date_created, 'YYYY-MM-DDT') || to_char(w.date_created, 'HH24:MI:SSOF')) as "date_created", (to_char(h.date_started, 'YYYY-MM-DDT') || to_char(h.date_started, 'HH24:MI:SSOF')) as "harvest_started", (to_char(h.date_ended, 'YYYY-MM-DDT') || to_char(h.date_ended, 'HH24:MI:SSOF')) as "harvest_ended", (to_char(c1.date_updated, 'YYYY-MM-DDT') || to_char(c1.date_updated, 'HH24:MI:SSOF')) as "date_updated", c1.type, c1.history_id FROM ui_warc w JOIN ui_harvest h ON w.harvest_id=h.id LEFT JOIN ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", sub_c.collection_id as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s JOIN ui_collection sub_c ON s.collection_id=sub_c.id) c1 ON h.collection_id=c1.collection_id AND c1.date_updated = (SELECT MAX(c2.date_updated) FROM ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", NULL as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s) c2 WHERE c2.collection_id=h.collection_id AND c2.date_updated <= h.date_started) ORDER BY h.collection_id, h.date_started;
    s: bsd:warcJSONFixity_$(warc_id)
    po:
      - [a, premis:Fixity]
      - [dc:title, "WARC Fixity $(warc_id)", en~lang]
      - [rdf:value, $(sha1)]
      - [dc:description, "The fixity of WARC file $(warc_id): '$(sha1)'.", en~lang]



  collectionsRepresentationVersion:
    creator: "<Sven.Lieber@ugent.be>"
    description: ""
    version: "v1.0.0"
    sources:
      - access: *dbHost
        type: *dbType
        credentials: *credentials
        queryFormulation: *sqlQueryFormulation
        referenceFormulation: *csvReferenceFormulation
        query: SELECT DISTINCT c1.collection_id_sfm, (to_char(c1.date_updated, 'YYYY-MM-DDT') || to_char(c1.date_updated, 'HH24:MI:SSOF')) as "date_updated", c1.collection_id, c1.type, c1.history_id FROM ui_harvest h LEFT JOIN ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", sub_c.collection_id as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s JOIN ui_collection sub_c ON s.collection_id=sub_c.id) c1 ON h.collection_id=c1.collection_id AND c1.date_updated = (SELECT MAX(c2.date_updated) FROM ( SELECT c.history_id as "history_id", c.date_updated as "date_updated", c.id as "collection_id", c.collection_id as "collection_id_sfm", 'collection' as "type" FROM ui_historicalcollection c UNION SELECT s.history_id as "history_id", s.date_updated as "date_updated", s.collection_id as "collection_id", NULL as "collection_id_sfm", 'seed' as "type" FROM ui_historicalseed s) c2 WHERE c2.collection_id=h.collection_id AND c2.date_updated <= h.date_started) WHERE c1.collection_id_sfm IS NOT NULL;
    s: bsd:collectionVersionJSON_$(collection_id_sfm)_$(type)_$(history_id)
    po:
      - [a, edm:WebResource]
      - [a, premis:Representation]
      - [a, bsm:SocialMediaCollectionRepresentationVersion]
      - [dcterms:identifier, $(collection_id_sfm)_$(type)_$(history_id)]
      - [ebucore:hasMimeType, "application/json"]
      - [dc:title, "JSON representation of collection $(collection_id_sfm) version '$(type)_$(history_id)'", en~lang]
      - [dc:description, "The version of this collection created at $(date_updated), including changes in the collection or related seeds since the last version.", en~lang]
      - [prov:generatedAtTime, $(date_updated), xsd:dateTime]
      - [prov:specializationOf, bsd:collectionJSON_$(collection_id_sfm)~iri]



